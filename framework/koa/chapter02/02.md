## 洋葱模型

### 前言
前面研究了koa的中间件引擎的原理, 在处理请求的时候代码执行会形成的嵌套结构, 我们将这个结构称为`洋葱模型`.下面我们来研究一下`洋葱模型`.



![洋葱模型](../img/onion.png)


洋葱模型下的HTTP处理流程:
1. 接收http请求, koa生成上下文
2. 上下文进入中间件1
3. 上下文进入中间件2
4. 上下文退出中间件2
5. 上下文退出中间件1
6. 返回http结果



### 扩展
其实koa的洋葱模型是一种AOP设计(面向切面编程)

- 什么是AOP?

    假设我们有一条生产流水线, 我们可以在随时在流水线上增加一道工序或移除一道工序, 那么工序就可以看出是一个切面. 增加/移除一个切面, 不应该对流水线其他工序有影响.

    什么是AOP? 在现有的代码程序中,在程序的生命周期或流程中`插入/减去`功能,不影响原有的功能的设计

- Koa的切面
    - koa的切面是由中间件机制实现的
    - 中间件一般上有两个切面
    - 中间件遵循先进后出的顺序

- 其他常见的切面
    - 一些hook的 `before/after` 函数 也是一种切面
