# V8的内存限制和垃圾回收

## 内存限制
node是基于V8构建的, 而V8对于内存的使用有一定的限制. 默认情况下, 64位的系统大概可以使用`1.4G`, 而32位则有`0.7G`.  
为什么会有这个限制呢?  
因为垃圾回收会暂停Js的运行， 如果内存过大， 就会导致垃圾回收的时间变长， 从而导致Js暂停的时间过长。

查看内存
在Node环境中， 可以通过`process.memoryUsage()`来查看内存分配

    rss（resident set size）：所有内存占用，包括指令区和堆栈

    heapTotal：V8引擎可以分配的最大堆内存，包含下面的 heapUsed

    heapUsed：V8引擎已经分配使用的堆内存

    external： V8管理C++对象绑定到JavaScript对象上的内存

对于大文件的操作通常会使用`Buffer`， 究其原因就是因为Node中内存小的原因， 而使用Buffer是不受这个限制， 它是堆外内存， 也就是上面提到的external。

## V8的内存分代
v8的内部其实采用的是两种垃圾回收算法: 新生代 和 老生代

### 新生代
`v8中的新生代主要存放的是生存周期较短的对象`， 它具有`两个空间semispace`， 分别为From和To， 在分配内存的时候将内存分配给From空间， 当垃圾回收的时候， 会检查From空间存活的对象(广度优先算法)并复制到To空间， 然后清空From空间， 再互相交换From和To空间的位置， 使得To空间变为From空间。  

在64位系统中一个semisapce为16MB， 而32位则为8MB， 所以`新生代内存大小分别为32MB和16MB`。

### 老生代

老生代
`老生代在64位和32位下具有的内存分别是1400MB和700MB`， V8在老生代中的垃圾回收策略采用Mark-Sweep和Mark-Compact相结合。